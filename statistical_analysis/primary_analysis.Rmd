---
title: "Analysis results"
author: "Akihiro Shiroshita"
date: "`r Sys.time()`"
output: 
    word_document:
      toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	fig.height = 4,
	fig.pos = "t",
	message = FALSE,
	warning = FALSE,
	dpi = 350,
	out.extra = ""
)
packages = c("devtools",
             "usethis",
             "here",
             "readr",
             "readxl",
             "expss",
             "tidyverse",
             "tidylog",
             "lubridate",
             "ggplot2",
             "RColorBrewer",
             "ggplotgui",
             "ggthemes",
             "arsenal",
             "stats",
             "epitools",
             "DescTools",
             "epiR",
             "RVAideMemoire",
             "tableone",
             "flextable",
             "huxtable",
             "naniar",
             "VIM",
             "margins",
             "modmarg",
             "broom",
             "aod",
             "fitdistrplus",
             "rms",
             "Hmisc",
             "mice",
             "mitools",
             "margins",
             "geepack",
             "multcomp",
             "WeightIt",
             "cobalt",
             "MatchIt")

package.check <- lapply(packages, FUN = function(x){
  if (!require(x, character.only = TRUE)){
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

# import data
df <- read_csv(here("output/analysis_data.csv"))

# I created multiple datasets for each objective
## dataset for creating table one
df_tab <- df %>% 
  mutate(rsv_pcr_age = trunc(time_length(interval(INFANTDOB, rftodaydate), "day"))) %>%
  dplyr::select(cfsubjid, STUDYENROLLDATE, INFANTDOB,
         # baseline characteristics (numeric)
         GESTAGEWK, BIRTHWEIGHT_GRAM, BREASTFEDDUR, OTHERLIVSIBS_BIO,
         OTHERLIVSIBS_HAL, HOUSEHOLDSIZE, MAT_EDUCYEARS,
         # baseline characteristics (categorical)
         sex, ethnicity, MATSMOKE_PREG, DAYCARE_OY, MAT_ASTHMA_EVER,
         EVERBREASTFED, DELIVERYMODE,
         MAT_MARITAL_STATUS, INSURANCE_CHILD, residence6mo,
         # exposure
         #rftodaydate, # PCR sampling date
         anyrsv_dev, # RSV positive
         rsv_pcr_age, # age at positive PCR sampling date
         #BSS2_dev, # severity
         oy_rsv_infected_dev, # PCR or serology positive
         rsv_exposed_dev, # serology
         # outcome
         oy_rec_whz_dev, ty_rec_whz_dev, ry_rec_whz_dev,
         fy_rec_whz_dev, vy_rec_whz_dev, xy_rec_whz_dev,
         fycurrentasthma_dev, vycurrentasthma_dev
         ) %>% 
  mutate(# baseline characteristics
         enroll_age = trunc(time_length(interval(INFANTDOB, STUDYENROLLDATE), "month")),
         sex = factor(sex, levels = c(0,1), labels = c("Female", "Male")),
         ethnicity = factor(ethnicity, levels = c(0,1,2), labels = c("Non-hispanic White", "Non-hispanic balck", "Hispanic and other")),
         MATSMOKE_PREG = factor(MATSMOKE_PREG, levels = c(0,1), labels = c("Not", "Maternal smoking during pregnancy")),
         DAYCARE_OY = factor(DAYCARE_OY, levels = c(0,1), labels = c("Not", "Daycase use furing the first year")),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         other_sib_cat = factor(other_sib_cat, levels = c(0,1,2), labels = c("None", "One sibling", "2 or more siblings")),
         MAT_ASTHMA_EVER = factor(MAT_ASTHMA_EVER, levels = c(0,1), labels = c("Not", "Maternal asthma")),
         EVERBREASTFED = factor(EVERBREASTFED, levels = c(0,1), labels = c("Not", "Breast feeding")),
         DELIVERYMODE = factor(DELIVERYMODE, levels = c(0,1), labels = c("Vaginal", "C-section")),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         MAT_EDUC_cat = factor(MAT_EDUC_cat, levels = c(0,1,2), labels = c("less than HS/GED", "HS/GED", "more than HS/GED")),
         MAT_MARITAL_STATUS = factor(MAT_MARITAL_STATUS, levels = c(1,2,3), labels = c("Single", "Married", "Divorces/Separated")),
         INSURANCE_CHILD = factor(INSURANCE_CHILD, levels = c(1,2,3,4,5), labels = c("Medicaid", "Private", "Self-Pay", "None", "Other")),
         residence6mo = factor(residence6mo, levels = c(0,1), labels = c("Rural", "Urban")),
         # exposure
         anyrsv_dev = factor(anyrsv_dev, levels = c(0,1), labels = c("Not","RSV PCR positive")),
         oy_rsv_infected_dev = factor(oy_rsv_infected_dev, levels = c(0,1), labels = c("Not", "PCR or Serology positive")),
         rsv_exposed_dev = factor(rsv_exposed_dev, levels = c(0,1), labels = c("Not", "Serology positive")),
         # outcome
         oy_rec_whz_dev = factor(oy_rec_whz_dev, levels = c(0,1), labels = c("Not", "Recurrent wheeze during the first year")),
         ty_rec_whz_dev = factor(ty_rec_whz_dev, levels = c(0,1), labels = c("Not", "Recurrent wheeze during the second year")),
         ry_rec_whz_dev = factor(ry_rec_whz_dev, levels = c(0,1), labels = c("Not", "Recurrent wheeze during the third year")),
         fy_rec_whz_dev = factor(fy_rec_whz_dev, levels = c(0,1), labels = c("Not", "Recurrent wheeze during the fourth year")),
         vy_rec_whz_dev = factor(vy_rec_whz_dev, levels = c(0,1), labels = c("Not", "Recurrent wheeze during the fifth year")),
         xy_rec_whz_dev = factor(xy_rec_whz_dev, levels = c(0,1), labels = c("Not", "Recurrent wheeze during the sixth year")),
         fycurrentasthma_dev = factor(fycurrentasthma_dev, levels = c(0,1), labels = c("Not", "Four-year current asthma")),
         vycurrentasthma_dev = factor(vycurrentasthma_dev, levels = c(0,1), labels = c("Not", "Five-year current asthma")),
         mis_age_tag = if_else(is.na(rsv_pcr_age), 1, 0),
         mis_age_tag = factor(mis_age_tag, levels = c(0,1), labels = c("PCR positive", "PCR negative/missing"))) %>% 
  filter(oy_rsv_infected_dev == "PCR or Serology positive")

## create a dataset for a complete case analysis & continuous age model
df_cont <- df %>% 
  mutate(enroll_age = trunc(time_length(interval(INFANTDOB, STUDYENROLLDATE), "month")),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         rsv_pcr_age = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_sero_age = trunc(time_length(interval(INFANTDOB, lmday1), "day"))) %>% 
  filter(oy_rsv_infected_dev == 1) %>% 
  dplyr::select(cfsubjid, STUDYENROLLDATE, INFANTDOB,
         # baseline characteristics (numeric)
         GESTAGEWK, BIRTHWEIGHT_GRAM, BREASTFEDDUR, OTHERLIVSIBS_BIO,
         OTHERLIVSIBS_HAL, HOUSEHOLDSIZE, MAT_EDUCYEARS,
         # baseline characteristics (categorical)
         sex, ethnicity, MATSMOKE_PREG, DAYCARE_OY, MAT_ASTHMA_EVER,
         EVERBREASTFED, DELIVERYMODE,
         MAT_MARITAL_STATUS, INSURANCE_CHILD, residence6mo,
         # exposure
         #rftodaydate, # PCR sampling date
         anyrsv_dev, # RSV positive
         rsv_pcr_age, # age at positive PCR sampling date
         #BSS2_dev, # severity
         oy_rsv_infected_dev, # PCR or serology positive
         rsv_exposed_dev, # serology
         # outcome
         oy_rec_whz_dev, ty_rec_whz_dev, ry_rec_whz_dev,
         fy_rec_whz_dev, vy_rec_whz_dev, xy_rec_whz_dev,
         fycurrentasthma_dev, vycurrentasthma_dev
         ) %>% 
  drop_na(rsv_pcr_age, vycurrentasthma_dev)

## create a dataset for a complete case analysis & categorical age model
df_cat <- df %>% 
  mutate(enroll_age = trunc(time_length(interval(INFANTDOB, STUDYENROLLDATE), "month")),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         rsv_pcr_age = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_sero_age = trunc(time_length(interval(INFANTDOB, lmday1), "day")),
         rsv_age_cat = case_when(rsv_pcr_age < 180 ~ 1,
                                 180 <= rsv_pcr_age & rsv_pcr_age < 365 ~ 0,
                                 365 < rsv_pcr_age | (is.na(rsv_pcr_age) & is.na(rsv_sero_age)) ~ 2))

## created a dataset for single imputation
df_sing_imp <- df_sing_imp2 <-  df_sing_imp3 <- df_mode_imp <- df %>% 
  mutate(enroll_age = trunc(time_length(interval(INFANTDOB, STUDYENROLLDATE), "month")),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         rsv_pcr_age = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_pcr_age_ori = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_sero_age = trunc(time_length(interval(INFANTDOB, lmday1), "day"))) %>% 
  filter(oy_rsv_infected_dev == 1) %>% 
  dplyr::select(cfsubjid, STUDYENROLLDATE, INFANTDOB,
         # baseline characteristics (numeric)
         GESTAGEWK, BIRTHWEIGHT_GRAM, BREASTFEDDUR, OTHERLIVSIBS_BIO,
         OTHERLIVSIBS_HAL, HOUSEHOLDSIZE, MAT_EDUCYEARS,
         # baseline characteristics (categorical)
         sex, ethnicity, MATSMOKE_PREG, DAYCARE_OY, MAT_ASTHMA_EVER,
         EVERBREASTFED, DELIVERYMODE,
         MAT_MARITAL_STATUS, INSURANCE_CHILD, residence6mo,
         # exposure
         #rftodaydate, # PCR sampling date
         anyrsv_dev, # RSV positive
         rsv_pcr_age, # age at positive PCR sampling date
         lmday1, #BSS2_dev, # severity
         oy_rsv_infected_dev, # PCR or serology positive
         rsv_exposed_dev, # serology
         # outcome
         oy_rec_whz_dev, ty_rec_whz_dev, ry_rec_whz_dev,
         fy_rec_whz_dev, vy_rec_whz_dev, xy_rec_whz_dev,
         fycurrentasthma_dev, vycurrentasthma_dev
         ) %>% 
  arrange(INFANTDOB)

```

# Descriptive analysis

## Missing data

```{r}
miss_tab <- miss_var_summary(df_tab)
miss_tab
```

```{r}
gg_miss_var(df_tab %>% dplyr::select(
         enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat, oy_rsv_infected_dev, rsv_pcr_age, vycurrentasthma_dev,
         fy_rec_whz_dev)) 
```

## Table one

```{r}
dvars <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat, oy_rsv_infected_dev, fy_rec_whz_dev,
         vycurrentasthma_dev) %>%
  colnames()
dfactorVars <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat, oy_rsv_infected_dev, fy_rec_whz_dev,
         vycurrentasthma_dev) %>%
  dplyr::select(where(is.factor)) %>% 
  colnames()

dtable0 <- CreateTableOne(vars = dvars,
                         data = df_tab,
                         includeNA = FALSE,
                         factorVars = dfactorVars)
dtable0 %>% 
  print(test = FALSE, contDigits = 1, catDigits = 1) %>% 
  as.data.frame() %>% 
  mutate("Variables" = c("Number of infants", "Age at enrollment (month)",
                    "Male sex", 
                    "Ethnicity", "\t Non-Hispanic White", "\t Non-Hispanic Black", "\t Hispanic and other",
                    "Maternal education", "\t Less than high school/general educational development",
                    "\t High school/general educational development",
                    "\t More than High school/general educational development",
                    "Maternal marital status", "\t Single",
                    "\t Married", "\t Divorces/Separated",
                    "Maternal history of asthma",
                    "Insurance of infant", "\t Medicaid", "\t Private", "\t Self-Pay", "\t None", "\t Other",
                    "Gestational age (weeks)", "Birth weight", 
                    "Birth by cesarean section", "Ever any breastfeeding", "Daycare use during the first year", 
                    "Presence of biological siblings", "\t None", "\t One sibling", "\t Two or more Siblings",
                    "RSV infection detected by PCR or serology during the first year", "Four-year recurrent wheeze",
                    "Five-year current asthma")) %>% 
  dplyr::select(Variables, everything()) %>% 
  regulartable() %>% 
  theme_booktabs() %>% 
  autofit()
```

## Table one stratified by the presence of PCR samling date

```{r}
dvars1 <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat, 
         fy_rec_whz_dev, vycurrentasthma_dev) %>%
  colnames()
dfactorVars1 <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat, fy_rec_whz_dev,
         vycurrentasthma_dev) %>%
  dplyr::select(where(is.factor)) %>% 
  colnames()

dtable1 <- CreateTableOne(vars = dvars1,
                         data = df_tab,
                         includeNA = FALSE,
                         factorVars = dfactorVars1,
                         strata = "mis_age_tag",
                         addOverall = TRUE)
dtable1 %>% 
  print(test = FALSE, contDigits = 1, catDigits = 1) %>% 
  as.data.frame() %>% 
  mutate("Variables" = c("Number of infants", "Age at enrollment (month)",
                    "Male sex", 
                    "Ethnicity", "\t Non-Hispanic White", "\t Non-Hispanic Black", "\t Hispanic and other",
                    "Maternal education", "\t Less than high school/general educational development",
                    "\t High school/general educational development",
                    "\t More than High school/general educational development",
                    "Maternal marital status", "\t Single",
                    "\t Married", "\t Divorces/Separated", "Maternal history of asthma",
                    "Insurance of infant", "\t Medicaid", "\t Private", "\t Self-Pay", "\t None", "\t Other",
                    "Gestational age (weeks)", "Birth weight", 
                    "Birth by cesarean section", "Ever any breastfeeding", "Daycare use during the first year",
                    "Presence of biological siblings", "\t None", "\t One sibling", "\t Two or more Siblings", "Four-year recurrent wheeze",
                    "Five-year current asthma")) %>% 
  dplyr::select(Variables, everything()) %>% 
  regulartable() %>% 
  theme_booktabs() %>% 
  autofit()
```

## Table one stratified by missing in 5-year current asthma

```{r}
df_tab <- df_tab %>% 
  mutate(mis_asthma_tag = if_else(is.na(vycurrentasthma_dev), 0, 1),
         mis_asthma_tag = factor(mis_asthma_tag, levels = c(0,1), labels = c("Missing 5-year current asthma","Complete 5-year current asthma")))

dvars <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat) %>%
  colnames()
dfactorVars <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, EVERBREASTFED, DAYCARE_OY, other_sib_cat, oy_rsv_infected_dev, fy_rec_whz_dev) %>%
  dplyr::select(where(is.factor)) %>% 
  colnames()

dtable2 <- CreateTableOne(vars = dvars,
                         data = df_tab,
                         includeNA = FALSE,
                         factorVars = dfactorVars,
                         strata = "mis_asthma_tag")
dtable2 %>% 
  print(test = FALSE, contDigits = 1, catDigits = 1) %>% 
  as.data.frame() %>% 
  mutate("Variables" = c("Number of infants", "Age at enrollment (month)",
                    "Male sex", 
                    "Ethnicity", "\t Non-Hispanic White", "\t Non-Hispanic Black", "\t Hispanic and other",
                    "Maternal education", "\t Less than high school/general educational development",
                    "\t High school/general educational development",
                    "\t More than High school/general educational development",
                    "Maternal marital status", "\t Single",
                    "\t Married", "\t Divorces/Separated",
                    "Maternal history of asthma",
                    "Insurance of infant", "\t Medicaid", "\t Private", "\t Self-Pay", "\t None", "\t Other",
                    "Gestational age (weeks)", "Birth weight", 
                    "Birth by cesarean section", "Ever any breastfeeding", "Daycare use during the first year", 
                    "Presence of biological siblings", "\t None", "\t One sibling", "\t Two or more Siblings")) %>% 
  dplyr::select(Variables, everything()) %>% 
  regulartable() %>% 
  theme_booktabs() %>% 
  autofit()
```
## Table one stratified by breastfeeding  

```{r}
df_tab <- df_tab %>% 
  mutate(mis_asthma_tag = if_else(is.na(vycurrentasthma_dev), 0, 1),
         mis_asthma_tag = factor(mis_asthma_tag, levels = c(0,1), labels = c("Missing 5-year current asthma","Complete 5-year current asthma")))

dvars <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, DAYCARE_OY, other_sib_cat, vycurrentasthma_dev, mis_asthma_tag) %>%
  colnames()
dfactorVars <- df_tab %>% 
  dplyr::select(enroll_age, sex, ethnicity, MAT_EDUC_cat, MAT_MARITAL_STATUS, MAT_ASTHMA_EVER, INSURANCE_CHILD, GESTAGEWK,
         BIRTHWEIGHT_GRAM, DELIVERYMODE, DAYCARE_OY, other_sib_cat, vycurrentasthma_dev, mis_asthma_tag) %>%
  dplyr::select(where(is.factor)) %>% 
  colnames()

dtable2 <- CreateTableOne(vars = dvars,
                         data = df_tab,
                         includeNA = FALSE,
                         factorVars = dfactorVars,
                         strata = "EVERBREASTFED")
dtable2 %>% 
  print(test = FALSE, contDigits = 1, catDigits = 1) %>% 
  as.data.frame() %>% 
  mutate("Variables" = c("Number of infants", "Age at enrollment (month)",
                    "Male sex", 
                    "Ethnicity", "\t Non-Hispanic White", "\t Non-Hispanic Black", "\t Hispanic and other",
                    "Maternal education", "\t Less than high school/general educational development",
                    "\t High school/general educational development",
                    "\t More than High school/general educational development",
                    "Maternal marital status", "\t Single",
                    "\t Married", "\t Divorces/Separated",
                    "Maternal history of asthma",
                    "Insurance of infant", "\t Medicaid", "\t Private", "\t Self-Pay", "\t None", "\t Other",
                    "Gestational age (weeks)", "Birth weight", 
                    "Birth by cesarean section", "Daycare use during the first year", 
                    "Presence of biological siblings", "\t None", "\t One sibling", "\t Two or more Siblings",
                    "5-year current asthma", "Completed follow-up")) %>% 
  dplyr::select(Variables, everything()) %>% 
  regulartable() %>% 
  theme_booktabs() %>% 
  autofit()
```

## Jitter plot

This jitter plot illustrates the relationship between age at the first RSV infection and the **presence** of 5-year current asthma among the children who had PCR positive. The red dots indicate the children who developed asthma at age 5 years old. The red dots indicate the children who did not develop asthma at age 5 years.

```{r}
cols <- brewer.pal(6, "Paired")
graph2 <- ggplot(df_cont, aes(x = rsv_pcr_age, y = jitter(vycurrentasthma_dev), color = as.factor(vycurrentasthma_dev))) +
  geom_point() +
  scale_color_manual(values=cols[c(2,6)]) +
  labs(x = 'Age at first RSV PCR positive (days)', y = 'The presence of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position="none"
  ) 
graph2
```

## Line plot

This figure illustrates the relationship between age at the first RSV infection and the **probability** of 5-year current asthma among the children who had PCR positive. The age at the first RSV infection was divided up into 10 day fragment to reflect the granularity of age effect.

```{r}
df_summary <- df_cont %>% 
  mutate(pcr_age_cat = cut(rsv_pcr_age, breaks = seq(0, 270, by = 10))) %>% 
  group_by(pcr_age_cat) %>%
  summarise(n = n(),
            noutcome = sum(vycurrentasthma_dev), na.rm = TRUE) %>%
  mutate(pcr_age_cat = seq(0, 260, by = 10),
         pcr_age_cat = factor(pcr_age_cat,
                              labels = c("10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100", "100-110", "110-120", "120-130", "130-140", "140-150", "150-160", "160-170", "170-180", "180-190", "190-200", "200-210", "210-220", "220-230", "230-240", "240-250", "250-260", "260-270", "270-280")),
         names = as.character(pcr_age_cat),
         prob = noutcome/n)
df_summary

graph <- ggplot(df_summary, aes(x = pcr_age_cat, y = prob)) +
  geom_line(aes(group=1)) +
  geom_point() +
  labs(x = 'Age at first RSV PCR positive (days)', y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) + 
  guides(color="none") 
graph
```

# Complete case analysis

## Continuous age + Univariable logistic regression

```{r}
ddist <- datadist(df_cont)
options(datadist='ddist')

Knots <- c("3 knots", "4 knots", "5 knots")
Model <- c("Univariable", "Multivariable")
results <- expand.grid(Knots = Knots, Model = Model)
col <- c("Coefficient of age", "p-value of age", "Non-linear effect", "Coefficient of sex", "p-value of sex", "AIC")
results[, col] <- NA

plsmo(df_cont$rsv_pcr_age,
      df_cont$vycurrentasthma_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 5-year current asthma")
title("Non-parametric smooth regression")

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i), data=df_cont)
  results[i-2, col[1]] <- anova(fit)[1,1]
  results[i-2, col[2]] <- anova(fit)[1,3]
  results[i-2, col[3]] <- anova(fit)[2,3]
  results[i-2, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Complete case analysis (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_cont, color = cols[6]) +
    scale_x_continuous(limits = c(50, 250))
  print(fig)
}
```

## Complete case analysis

## Continuous age + Multivariable logistic regression

```{r}
ddist <- datadist(df_cont)
options(datadist='ddist')

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i) + sex, data=df_cont)
  results[i+1, col[1]] <- anova(fit)[1,1]
  results[i+1, col[2]] <- anova(fit)[1,3]
  results[i+1, col[3]] <- anova(fit)[2,3]
  results[i+1, col[4]] <- anova(fit)[3,1]
  results[i+1, col[5]] <- anova(fit)[3,3]
  results[i+1, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Complete case analysis (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_cont, color = cols[6]) +
    scale_x_continuous(limits = c(50, 250))
  print(fig)
}

```

## Complete case analysis results summary

```{r}
results
```

# Mode imputation  

```{r}
mode_2012 <- "2012/12/30"
mode_2013 <- "2013/12/30"

for (row in 1:(nrow(df_mode_imp %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))) {
  df_mode_imp$rsv_pcr_age[row] = if_else(is.na(df_mode_imp$rsv_pcr_age[row]),  trunc(time_length(interval(df_mode_imp$INFANTDOB[row],ymd(mode_2012)), "day")), df_mode_imp$rsv_pcr_age[row])
}

## step 2

for (row in (nrow(df_mode_imp %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_mode_imp %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_mode_imp %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_mode_imp$rsv_pcr_age[row] = if_else(is.na(df_mode_imp$rsv_pcr_age[row]),  trunc(time_length(interval(df_mode_imp$INFANTDOB[row], ymd(mode_2013)), "day")), df_mode_imp$rsv_pcr_age[row])
}
```

## Continuous model  

```{r}
ddist <- datadist(df_mode_imp)
options(datadist='ddist')

Knots <- c("3 knots", "4 knots", "5 knots")
Model <- c("Univariable", "Multivariable")
results <- expand.grid(Knots = Knots, Model = Model)
col <- c("Coefficient of age", "p-value of age", "Non-linear effect", "Coefficient of sex", "p-value of sex", "AIC")
results[, col] <- NA

plsmo(df_mode_imp$rsv_pcr_age,
      df_mode_imp$vycurrentasthma_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 5-year current asthma")
title("Non-parametric smooth regression")

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i), data=df_mode_imp)
  results[i-2, col[1]] <- anova(fit)[1,1]
  results[i-2, col[2]] <- anova(fit)[1,3]
  results[i-2, col[3]] <- anova(fit)[2,3]
  results[i-2, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Mode imputation analysis (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_cont, color = cols[6]) +
    scale_x_continuous(limits = c(50, 250))
  print(fig)
}
```


# Single imputation

![](imp_figure.svg)

## algorithm  
### Step 1

1.  Pick up the children who were born between **2012/4/1** and **2013/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **also** missing or later than April 1, randomly drew a date between 2012/10/1 and 2013/4/1\
3.  Then calculate the age at RSV PCR positive

### Step 2

1.  Pick up the children who were born between **2013/4/1** and **2014/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **also** missing, randomly drew a date between 2013/10/1 and 2014/4/1\
3.  Then calculate the age at RSV PCR positive

### Step 3

1.  Pick up the children who were born between **2012/4/1** and **2013/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **not** missing, randomly drew a date between 2012/10/1 and **RSV serology sampling date**\
3.  Then calculate the age at RSV PCR positive

### Step 4

1.  Pick up the children who were born between **2013/4/1** and **2014/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **not** missing, randomly drew a date between 2013/10/1 and **RSV serology sampling date**\
3.  Then calculate the age at RSV PCR positive

```{r include=FALSE}
set.seed(1234)

## step 1

for (row in 1:(nrow(df_sing_imp %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))) {
  df_sing_imp$rsv_pcr_age[row] = if_else(is.na(df_sing_imp$rsv_pcr_age[row]) & !is.na(df_sing_imp$lmday1[row]),  trunc(time_length(interval(df_sing_imp$INFANTDOB[row], sample(seq(max(df_sing_imp$INFANTDOB[row], as.Date("2012/10/1")), min(df_sing_imp$lmday1[row], as.Date("2013/4/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp$rsv_pcr_age[row])
}

## step 2

for (row in (nrow(df_sing_imp %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp$rsv_pcr_age[row] = if_else(is.na(df_sing_imp$rsv_pcr_age[row]) & !is.na(df_sing_imp$lmday1[row]),  trunc(time_length(interval(df_sing_imp$INFANTDOB[row], sample(seq(max(df_sing_imp$INFANTDOB[row], as.Date("2013/10/1")), min(df_sing_imp$lmday1[row], as.Date("2014/4/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp$rsv_pcr_age[row])
}

## step 3

for (row in 1:(nrow(df_sing_imp %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))){
  df_sing_imp$rsv_pcr_age[row] = if_else(is.na(df_sing_imp$rsv_pcr_age[row]) & is.na(df_sing_imp$lmday1[row]),  trunc(time_length(interval(df_sing_imp$INFANTDOB[row], sample(seq(max(df_sing_imp$INFANTDOB[row], as.Date("2012/10/1")), as.Date("2013/4/1"), by = "day"), 1)), "day")), df_sing_imp$rsv_pcr_age[row])
}

## step 4  

for (row in (nrow(df_sing_imp %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp$rsv_pcr_age[row] = if_else(is.na(df_sing_imp$rsv_pcr_age[row]) & is.na(df_sing_imp$lmday1[row]),  trunc(time_length(interval(df_sing_imp$INFANTDOB[row], sample(seq(max(df_sing_imp$INFANTDOB[row], as.Date("2013/10/1")), as.Date("2014/4/1"), by = "day"), 1)), "day")), df_sing_imp$rsv_pcr_age[row])
}
```

## Validation

This figure illustrates the difference between real age at first RSV infection among the children who had positive PCR results and the imputed value. We aimed not to perfectly impute the age, but moderately estimate the age with some uncertainty. Our single imputation was not perfect, but good.

```{r}
## created a dataset for this validation  
df_sing_imp_val <- df %>% 
  mutate(enroll_age = trunc(time_length(interval(INFANTDOB, STUDYENROLLDATE), "month")),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         rsv_pcr_age = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_pcr_age_ori = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_sero_age = trunc(time_length(interval(INFANTDOB, lmday1), "day"))) %>% 
  filter(oy_rsv_infected_dev == 1) %>% 
  dplyr::select(cfsubjid, fycurrentasthma_dev, vycurrentasthma_dev, rsv_pcr_age, rsv_pcr_age_ori, sex, INFANTDOB, lmday1, oy_rec_whz_dev, ty_rec_whz_dev, ry_rec_whz_dev, vycurrentasthma_dev, vy_rec_whz_dev, xy_rec_whz_dev, oy_rsv_infected_dev) %>% 
  arrange(INFANTDOB) %>% 
  filter(!is.na(rsv_pcr_age)) %>% 
  mutate(val = NA_real_)

## perform the same imputation algorithm 
## caveat: we have to delete "if_else(is.na(df_sing_imp$rsv_pcr_age[row]...".
set.seed(1234)

### step 1

for (row in 1:(nrow(df_sing_imp_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))) {
  df_sing_imp_val$rsv_pcr_age_val[row] = if_else(!is.na(df_sing_imp_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp_val$INFANTDOB[row], sample(seq(max(df_sing_imp_val$INFANTDOB[row], as.Date("2012/10/1")), min(df_sing_imp_val$lmday1[row], as.Date("2013/4/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp_val$rsv_pcr_age_val[row])
}

### step 2

for (row in (nrow(df_sing_imp_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp_val %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp_val %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp_val$rsv_pcr_age_val[row] = if_else(!is.na(df_sing_imp_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp_val$INFANTDOB[row], sample(seq(max(df_sing_imp_val$INFANTDOB[row], as.Date("2013/10/1")), min(df_sing_imp_val$lmday1[row], as.Date("2014/4/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp_val$rsv_pcr_age_val[row])
}

### step 3

for (row in 1:(nrow(df_sing_imp_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))){
  df_sing_imp_val$rsv_pcr_age_val[row] = if_else(is.na(df_sing_imp_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp_val$INFANTDOB[row], sample(seq(max(df_sing_imp_val$INFANTDOB[row], as.Date("2012/10/1")), as.Date("2013/4/1"), by = "day"), 1)), "day")), df_sing_imp_val$rsv_pcr_age_val[row])
}

### step 4  

for (row in (nrow(df_sing_imp_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp_val %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp_val %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp_val$rsv_pcr_age_val[row] = if_else(is.na(df_sing_imp_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp_val$INFANTDOB[row], sample(seq(max(df_sing_imp_val$INFANTDOB[row], as.Date("2013/10/1")), as.Date("2014/4/1"), by = "day"), 1)), "day")), df_sing_imp_val$rsv_pcr_age_val[row])
}

## compare the real value and imputed value among children who had a positive PCR result

graph <- ggplot(df_sing_imp_val, aes(x = rsv_pcr_age_val, y = rsv_pcr_age_ori)) +
  geom_point() +
  labs(x = 'Imputed age', y = 'Original value') +
  xlim(0, 300) + 
  ylim(0, 300) + 
  geom_abline(intercept = 0, slope = 1, color = cols[6]) +
  theme_bw()
graph
```

## Jitter plot

This jitter plot illustrates the relationship between age at the first RSV infection and the **presence** of 5-year current asthma among the children who had PCR positive. The red dots indicate the children who developed asthma at age 5 years old. The red dots indicate the children who did not develop asthma at age 5 years.

```{r}
df_sing_imp <- df_sing_imp %>% 
  mutate(imp_tag = if_else(is.na(rsv_pcr_age_ori), 1, 0),
         color_tag = case_when(vycurrentasthma_dev == 0 & imp_tag == 0 ~ 0,
                               vycurrentasthma_dev == 0 & imp_tag == 1 ~ 1,
                               vycurrentasthma_dev == 1 & imp_tag == 0 ~ 2,
                               vycurrentasthma_dev == 1 & imp_tag == 1 ~ 3,))

cols <- brewer.pal(6, "Paired")
graph2 <- ggplot(df_sing_imp, aes(x = rsv_pcr_age, y = jitter(vycurrentasthma_dev), color = as.factor(color_tag))) +
  geom_point() +
  scale_color_manual(values=cols[c(6,5,2,1)],
                     name = "Legend",
                     breaks = c("2", "3", "0", "1"),
                     labels = c("Only PCR +", "Imputed", "Only PCR +", "Imputed")) +
  labs(x = 'Age at first RSV PCR positive (days)', y = '5-year current asthma') +
  theme_classic() + 
  theme(axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_blank(),
        text = element_text(family = 'Helvetica'),
        axis.ticks.y = element_blank()) 
graph2
```
## Jitter plot stratified by breastfeeding  

```{r}
cols <- brewer.pal(8, "Paired")
graph2 <- ggplot(df_sing_imp, aes(x = rsv_pcr_age, y = jitter(vycurrentasthma_dev), color = as.factor(EVERBREASTFED))) +
  geom_point() +
  scale_color_manual(values=cols[c(2,6)]) +
  labs(x = 'Age at first RSV PCR positive (days)', y = 'The presence of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position="none"
  ) 
graph2
```

## Line plot

```{r}
df_sing_imp_vis <- df_sing_imp %>% 
  drop_na(rsv_pcr_age, vycurrentasthma_dev)

df_summary2 <- df_sing_imp_vis %>% 
  mutate(pcr_age_cat = cut(rsv_pcr_age, breaks = seq(0, 360, by = 10))) %>% 
  group_by(pcr_age_cat) %>%
  summarise(n = n(),
            noutcome = sum(vycurrentasthma_dev), na.rm = TRUE) %>%
  mutate(pcr_age_cat = seq(0, 290, by = 10),
         pcr_age_cat = factor(pcr_age_cat,
                              labels = c("0-10","10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100", "100-110", "110-120", "120-130", "130-140", "140-150", "150-160", "160-170", "170-180", "180-190", "190-200", "200-210", "210-220", "220-230", "230-240", "240-250", "250-260", "260-270", "270-280", "280-290", "290-300")),
         names = as.character(pcr_age_cat),
         prob = noutcome/n)
df_summary2 %>% write.csv("count.csv")

graph2 <- ggplot() +
  geom_line(data = df_summary2, aes(x = pcr_age_cat, y = prob, color = "red", group = 1)) +
  geom_point(data = df_summary2, aes(x = pcr_age_cat, y = prob, color = "red")) +
  geom_line(data = df_summary, aes(x = pcr_age_cat, y = prob, color = "blue", group = 1)) +
  geom_point(data = df_summary, aes(x = pcr_age_cat, y = prob, color = "blue")) + 
  scale_color_manual(values=cols[c(2,6)],
                     name = "Legend",
                     breaks = c("blue", "red"),
                     labels = c("Only PCR +", "Imputed data")) +
  labs(x = 'Age at first RSV PCR positive (days)', y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 6),
    text = element_text(family = 'Helvetica'),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position="none"
  ) 
  
graph2
```

This figure illustrates the relationship between age at the first RSV infection and the **probability** of 5-year current asthma among the children who had PCR positive. The age at the first RSV infection was divided up into 10 day fragment to reflect the granularity of age effect. The blue line indicates the children who had positive RSC PCR while the red line indicates the imputed date set. Of course, the red line is less jagged than the blue line.

# Single imputed model

## Continuous age + Univariable logistic regression

```{r}
ddist <- datadist(df_sing_imp)
options(datadist='ddist')

Knots <- c("3 knots", "4 knots", "5 knots")
Model <- c("Univariable", "Multivariable")
imp_results <- expand.grid(Knots = Knots, Model = Model)
col <- c("Coefficient of age", "p-value of age", "Non-linear effect", "Coefficient of sex", "p-value of sex", "AIC")
imp_results[, col] <- NA

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i), data=df_sing_imp)
  imp_results[i-2, col[1]] <- anova(fit)[1,1]
  imp_results[i-2, col[2]] <- anova(fit)[1,3]
  imp_results[i-2, col[3]] <- anova(fit)[2,3]
  imp_results[i-2, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp, color = cols[6]) +
    scale_x_continuous(limits = c(30, 280))
  print(fig)
}

fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4), data=df_sing_imp)
anova(fit)

fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age",conf.int = FALSE), ylab="Probability of 5-year current asthma") +
    labs(x = 'Age at first RSV PCR positive (days)',
         y = 'Probability of 5-year current asthma',
         title = paste("Imputed model (RCS with ", 4, " knots)")) +
    theme_classic() +
    theme(
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 8),
        text = element_text(family = 'Helvetica'),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()
    ) +
    scale_x_continuous(limits = c(30, 250)) + geom_rect(aes(xmin=100,xmax=250,ymin=0,ymax=0.4),
                                                        alpha=0.01,
                                                        fill="grey")

```
## Effect modification of breastfeeding  

```{r}
ggplot(df_sing_imp, aes(rsv_pcr_age, vycurrentasthma_dev, color=factor(EVERBREASTFED,
                                                                       levels = c(0,1),
                                                                       labels = c("Never", "Ever")))) +
  stat_smooth(method="loess", formula=y~x,
              alpha=0.2, se= FALSE, size=1) +
  labs(x = 'Age at first RSV PCR positive (days)',
     y = 'Probability of 5-year current asthma') +
  scale_color_manual(name = "Breastfeeding at baseline",
                     values=cols[c(6,2)]) +
  geom_vline(xintercept=100, linetype="dashed", color = "black") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) 

ggplot(df_sing_imp, aes(rsv_pcr_age, vycurrentasthma_dev, color=factor(EVERBREASTFED,
                                                                       levels = c(0,1),
                                                                       labels = c("Never", "Ever")))) +
  stat_smooth(method="loess", formula=y~x,
              alpha=0.2, size=1) +
  labs(x = 'Age at first RSV PCR positive (days)',
     y = 'Probability of 5-year current asthma',
     title = "Non-parametric smooth regression") +
  scale_color_manual(name = "Breastfeeding at baseline",
                     values=cols[c(6,2)]) +
  geom_vline(xintercept=100, linetype="dashed", color = "black") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) 

df_sing_imp_em1 <- df_sing_imp %>% 
  filter(EVERBREASTFED==1)
ddist <- datadist(df_sing_imp_em1)
options(datadist='ddist')

fit1 <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4), data=df_sing_imp_em1)
anova(fit1)
fig1 <- ggplot(Predict(fit1, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp_em1, color = cols[6]) +
    scale_x_continuous(limits = c(30, 280))

df_sing_imp_em2 <- df_sing_imp %>% 
  filter(EVERBREASTFED==0)
ddist <- datadist(df_sing_imp_em2)
options(datadist='ddist')

fit2 <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 5), data=df_sing_imp_em2)
anova(fit2)
fig2 <- ggplot(Predict(fit2, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp_em2, color = cols[6]) +
    scale_x_continuous(limits = c(30, 280))

par(mfrow=c(1,2))
plsmo(df_sing_imp_em1$rsv_pcr_age,
      df_sing_imp_em1$vycurrentasthma_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 5-year current asthma")
plsmo(df_sing_imp_em2$rsv_pcr_age,
      df_sing_imp_em2$vycurrentasthma_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 5-year current asthma")
```

## Continuous age + Multivariable logistic regression

```{r}
ddist <- datadist(df_sing_imp)
options(datadist='ddist')

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i) + sex, data=df_sing_imp)
  imp_results[i+1, col[1]] <- anova(fit)[1,1]
  imp_results[i+1, col[2]] <- anova(fit)[1,3]
  imp_results[i+1, col[3]] <- anova(fit)[2,3]
  imp_results[i+1, col[4]] <- anova(fit)[3,1]
  imp_results[i+1, col[5]] <- anova(fit)[3,3]
  imp_results[i+1, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp, color = cols[6]) +
    scale_x_continuous(limits = c(30, 250))
  print(fig)
}

fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4), data=df_sing_imp)

plot_df <- cbind(fitted = fitted(fit))
ggplot(Predict(fit, fun=plogis, "rsv_pcr_age",conf.int = FALSE), ylab="Probability of 5-year current asthma") +
    labs(x = 'Age at first RSV PCR positive (days)',
         y = 'Probability of 5-year current asthma',
         title = paste("Imputed model (RCS with ", 4, " knots)")) +
    theme_classic() +
    theme(
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 8),
        text = element_text(family = 'Helvetica'),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()
    ) +
    scale_x_continuous(limits = c(30, 250)) 
```

## Generalized propensity score analysis  

The individual-level treatment effect is the mean of the vector of potential outcomes.  
Create weights that make the Pearson's correlation between the treatment and the covariates as close to zero as possible.  

```{r}
df_sing_imp <- df_sing_imp %>% 
  mutate(sex = factor(sex),
         ethnicity = factor(ethnicity),
         MATSMOKE_PREG = factor(MATSMOKE_PREG),
         DAYCARE_OY = factor(DAYCARE_OY, levels = c(0,1)),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         other_sib_cat = factor(other_sib_cat),
         MAT_ASTHMA_EVER = factor(MAT_ASTHMA_EVER),
         EVERBREASTFED = factor(EVERBREASTFED),
         DELIVERYMODE = factor(DELIVERYMODE),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         MAT_EDUC_cat = factor(MAT_EDUC_cat),
         MAT_MARITAL_STATUS = factor(MAT_MARITAL_STATUS),
         INSURANCE_CHILD = factor(INSURANCE_CHILD))


formula <- "rsv_pcr_age ~ sex + ethnicity + EVERBREASTFED + DAYCARE_OY + MATSMOKE_PREG + MAT_ASTHMA_EVER + DELIVERYMODE + OTHERLIVSIBS_BIO + MAT_EDUCYEARS + INSURANCE_CHILD + MAT_MARITAL_STATUS"
cw <- weightit(as.formula(formula),
               data = df_sing_imp,
               method = "cbps",
               over = FALSE)
love.plot(cw,
          binary = "std",
          var.order = "un",
          stats = "corr",
          abs = TRUE,
          threshholds = c(0.1, 0.05)) +
  theme(legend.position = "top")

fit <- glm(vycurrentasthma_dev~rsv_pcr_age + I(rsv_pcr_age^2),
           data = df_sing_imp,
           weights = cw$weights,
           family=quasibinomial())
marg <- marg(fit, var_interest="rsv_pcr_age", at=list(rsv_pcr_age = seq(30,300,10)))
marg <- bind_rows(marg)
colnames(marg) <- c("label", "margin", "se", "z", "pvalue", "lower", "upper")

marg <- marg %>% 
  mutate(age = seq(30,300,10),
         margin = 100*margin,
         upper = 100*upper,
         lower = 100*lower,
         group = "overall")

ggplot(marg, aes(x=age)) + 
  geom_line(aes(y=margin)) + 
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.5, linetype=2) +
  theme(legend.title = element_blank(), panel.grid.minor=element_blank())

formula <- formula("rsv_pcr_age ~ sex + ethnicity + EVERBREASTFED + DAYCARE_OY + MATSMOKE_PREG + MAT_ASTHMA_EVER + DELIVERYMODE + OTHERLIVSIBS_BIO + MAT_EDUCYEARS + INSURANCE_CHILD + MAT_MARITAL_STATUS")

model <- lm(formula = formula, data = df_sing_imp)

df_sing_imp$gps <- dnorm(df_sing_imp$rsv_pcr_age, mean = model$fitted, sd = sd(df_sing_imp$rsv_pcr_age))
df_sing_imp$numerator <- with(df_sing_imp, dnorm(rsv_pcr_age,
                                                 mean = mean(rsv_pcr_age),
                                                 sd = sd(rsv_pcr_age)))
df_sing_imp$ipw <- with(df_sing_imp, numerator/gps)
summary(df_sing_imp$ipw)

designIPW <- svydesign(ids=~1, weights=~ipw, data=df_sing_imp)

balanceTable <- data.frame()
covariateNames <- c("sex", "ethnicity", "EVERBREASTFED", "DAYCARE_OY", "MATSMOKE_PREG", "MAT_ASTHMA_EVER", "DELIVERYMODE", "OTHERLIVSIBS_BIO", "MAT_EDUCYEARS", "INSURANCE_CHILD", "MAT_MARITAL_STATUS")

for (var in 1:length(covariateNames)) {
  balanceFormula <- paste("rsv_pcr_age~",
                          covariateNames[var],
                          sep="")
  maxEffBaseline <- max(abs(coef(svyglm(balanceFormula,designIPW))[-1]))
  maxEffIPW <- max(abs(coef(svyglm(balanceFormula,designIPW))[-1]))
  balanceTable <- rbind(balanceTable,
                        c(var,
                          maxEffBaseline,
                          maxEffIPW))}
names(balanceTable) <- c("variable",
                         "coefBaseline",
                         "coefIPW")
balanceTable$variable <- covariateNames
balanceTable$coefBaseline <- balanceTable$coefBaseline/sqrt(coef(svyvar(~rsv_pcr_age,designIPW)))
balanceTable$coefIPW <- balanceTable$coefIPW/sqrt(coef(svyvar(~rsv_pcr_age,designIPW)))
balanceTable

designIPW <- svydesign(ids=~1,weights=~ipw,data=df_sing_imp)
outcomeModelDR <- svyglm(formula= vycurrentasthma_dev~rsv_pcr_age + I(rsv_pcr_age^2),
                         design = designIPW,
                         family=binomial())
summary(outcomeModelDR)

marg <- marg(outcomeModelDR, var_interest="rsv_pcr_age", at=list(rsv_pcr_age = seq(30,300,10)))
marg <- bind_rows(marg)
colnames(marg) <- c("label", "margin", "se", "z", "pvalue", "lower", "upper")

marg <- marg %>% 
  mutate(age = seq(30,300,10),
         margin = 100*margin,
         upper = 100*upper,
         lower = 100*lower,
         group = "overall")

ggplot(marg, aes(x=age)) + 
  geom_line(aes(y=margin)) + 
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.5, linetype=2) +
  theme(legend.title = element_blank(), panel.grid.minor=element_blank())
```

## Effect modification  

```{r}
fit1 <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4) + sex, data=df_sing_imp %>% filter(EVERBREASTFED==0))

anova(fit1)

plot_df1 <- Predict(fit1, fun=plogis, "rsv_pcr_age") 

fit2 <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4) + sex, data=df_sing_imp%>% filter(EVERBREASTFED==1))

anova(fit2)

plot_df2 <- Predict(fit2, fun=plogis, "rsv_pcr_age") %>% rename(yhat2 = yhat, lower2 = lower, upper2 = upper)

plot_df <- cbind(plot_df1, plot_df2$yhat2, plot_df2$lower2, plot_df2$upper2) %>% rename(yhat2 = `plot_df2$yhat2`, lower2 = `plot_df2$lower2`, upper2 = `plot_df2$upper2`) 

ggplot(plot_df) +
  geom_line(mapping = aes(rsv_pcr_age, yhat), color = cols[c(6)]) +
   geom_ribbon(mapping = aes(x = rsv_pcr_age, y = yhat, xmin = 30, xmax = 250, ymin = lower, ymax = upper), alpha = 0.3, fill = cols[c(5)]) + 
  geom_line(mapping = aes(rsv_pcr_age, yhat2), color = cols[c(2)]) +
  geom_ribbon(mapping = aes(x = rsv_pcr_age, y = yhat, xmin = 30, xmax = 250, ymin = lower2, ymax = upper2), alpha = 0.3, fill = cols[c(1)]) + 
    labs(x = 'Age at first RSV PCR positive (days)',
         y = 'Probability of 5-year current asthma',
         title = paste("Imputed model (RCS with ", 4, " knots)")) +
    theme_classic() +
    theme(
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 8),
        text = element_text(family = 'Helvetica'),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()
    ) +
  scale_x_continuous(limits = c(30, 250)) 

fit_sub <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4)*EVERBREASTFED + sex, data=df_sing_imp)

anova(fit_sub)
```

## Imputed models results summary

```{r}
imp_results
```

# More precise seasonality  

```{r eval=FALSE, include=FALSE}
set.seed(1234)

## step 1

for (row in 1:(nrow(df_sing_imp3 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/2/28"))))) {
  df_sing_imp3$rsv_pcr_age[row] = if_else(is.na(df_sing_imp3$rsv_pcr_age[row]) & !is.na(df_sing_imp3$lmday1[row]),  trunc(time_length(interval(df_sing_imp3$INFANTDOB[row], sample(seq(max(df_sing_imp3$INFANTDOB[row], as.Date("2013/1/1")), min(df_sing_imp3$lmday1[row], as.Date("2013/2/28"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp3$rsv_pcr_age[row])
}

## step 2

for (row in (nrow(df_sing_imp3 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/2/28")))+1):(nrow(df_sing_imp3 %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/2/28"))) + nrow(df_sing_imp3 %>% filter(as.Date("2013/2/28") <= INFANTDOB & INFANTDOB < as.Date("2014/2/28"))))){
  df_sing_imp3$rsv_pcr_age[row] = if_else(is.na(df_sing_imp3$rsv_pcr_age[row]) & !is.na(df_sing_imp3$lmday1[row]),  trunc(time_length(interval(df_sing_imp3$INFANTDOB[row], sample(seq(max(df_sing_imp3$INFANTDOB[row], as.Date("2014/1/1")), min(df_sing_imp3$lmday1[row], as.Date("2014/2/28"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp3$rsv_pcr_age[row])
}

## step 3

for (row in 1:(nrow(df_sing_imp3 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/2/28"))))){
  df_sing_imp3$rsv_pcr_age[row] = if_else(is.na(df_sing_imp3$rsv_pcr_age[row]) & is.na(df_sing_imp3$lmday1[row]),  trunc(time_length(interval(df_sing_imp3$INFANTDOB[row], sample(seq(max(df_sing_imp3$INFANTDOB[row], as.Date("2013/1/1")), as.Date("2013/2/28"), by = "day"), 1)), "day")), df_sing_imp3$rsv_pcr_age[row])
}

## step 4  

for (row in (nrow(df_sing_imp3 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/2/28")))+1):(nrow(df_sing_imp3 %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/2/28"))) + nrow(df_sing_imp3 %>% filter(as.Date("2013/2/28") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp3$rsv_pcr_age[row] = if_else(is.na(df_sing_imp3$rsv_pcr_age[row]) & is.na(df_sing_imp3$lmday1[row]),  trunc(time_length(interval(df_sing_imp3$INFANTDOB[row], sample(seq(max(df_sing_imp3$INFANTDOB[row], as.Date("2014/1/1")), as.Date("2014/2/28"), by = "day"), 1)), "day")), df_sing_imp3$rsv_pcr_age[row])
}
```

## Continuous age + Univariable logistic regression

```{r eval=FALSE, include=FALSE}
ddist <- datadist(df_sing_imp3)
options(datadist='ddist')

Knots <- c("3 knots", "4 knots", "5 knots")
Model <- c("Univariable", "Multivariable")
imp_results <- expand.grid(Knots = Knots, Model = Model)
col <- c("Coefficient of age", "p-value of age", "Non-linear effect", "Coefficient of sex", "p-value of sex", "AIC")
imp_results[, col] <- NA

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i), data=df_sing_imp3)
  imp_results[i-2, col[1]] <- anova(fit)[1,1]
  imp_results[i-2, col[2]] <- anova(fit)[1,3]
  imp_results[i-2, col[3]] <- anova(fit)[2,3]
  imp_results[i-2, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp3, color = cols[6]) +
    scale_x_continuous(limits = c(30, 280))
  print(fig)
}

fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, 4), data=df_sing_imp3)
anova(fit)

fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age",conf.int = FALSE), ylab="Probability of 5-year current asthma") +
    labs(x = 'Age at first RSV PCR positive (days)',
         y = 'Probability of 5-year current asthma',
         title = paste("Imputed model (RCS with ", 4, " knots)")) +
    theme_classic() +
    theme(
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 8),
        text = element_text(family = 'Helvetica'),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank()
    ) +
    scale_x_continuous(limits = c(30, 250)) + geom_rect(aes(xmin=100,xmax=250,ymin=0,ymax=0.4),
                                                        alpha=0.01,
                                                        fill="grey")

```

# Sensitivity analysis  
## Different outcome  

### Complete case analysis
### Continuous age + Univariable logistic regression

```{r}
ddist <- datadist(df_sing_imp)
options(datadist='ddist')

plsmo(df_cont$rsv_pcr_age,
      df_cont$fy_rec_whz_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 4-year recurrent wheeze")
title("Non-parametric smooth regression")

for (i in 3:5) {
  fit <- lrm(fy_rec_whz_dev ~ rcs(rsv_pcr_age, i), data=df_sing_imp)
  imp_results[i+1, col[1]] <- anova(fit)[1,1]
  imp_results[i+1, col[2]] <- anova(fit)[1,3]
  imp_results[i+1, col[3]] <- anova(fit)[2,3]
  imp_results[i+1, col[4]] <- anova(fit)[3,1]
  imp_results[i+1, col[5]] <- anova(fit)[3,3]
  imp_results[i+1, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 4-year recurrent wheeze") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 4-year recurrent wheeze',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp, color = cols[6]) +
    scale_x_continuous(limits = c(30, 250))
  print(fig)
}
```

### Continuous age + Multivariable logistic regression

```{r}
ddist <- datadist(df_sing_imp)
options(datadist='ddist')

for (i in 3:5) {
  fit <- lrm(fy_rec_whz_dev ~ rcs(rsv_pcr_age, i) + sex, data=df_sing_imp)
  imp_results[i+1, col[1]] <- anova(fit)[1,1]
  imp_results[i+1, col[2]] <- anova(fit)[1,3]
  imp_results[i+1, col[3]] <- anova(fit)[2,3]
  imp_results[i+1, col[4]] <- anova(fit)[3,1]
  imp_results[i+1, col[5]] <- anova(fit)[3,3]
  imp_results[i+1, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 4-year recurrent wheeze") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 4-year recurrent wheeze',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp, color = cols[6]) +
    scale_x_continuous(limits = c(30, 250))
  print(fig)
}

```

### Different outcome complete case analysis results summary

```{r}
results
```

### Imputed model
### Continuous age + Univariable logistic regression

```{r}
ddist <- datadist(df_sing_imp)
options(datadist='ddist')

Knots <- c("3 knots", "4 knots", "5 knots")
Model <- c("Univariable", "Multivariable")
imp_results <- expand.grid(Knots = Knots, Model = Model)
col <- c("Coefficient of age", "p-value of age", "Non-linear effect", "Coefficient of sex", "p-value of sex", "AIC")
imp_results[, col] <- NA

plsmo(df_sing_imp$rsv_pcr_age,
      df_sing_imp$fy_rec_whz_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 5-year current asthma")
title("Non-parametric smooth regression")

for (i in 3:5) {
  fit <- lrm(fy_rec_whz_dev ~ rcs(rsv_pcr_age, i), data=df_sing_imp)
  imp_results[i-2, col[1]] <- anova(fit)[1,1]
  imp_results[i-2, col[2]] <- anova(fit)[1,3]
  imp_results[i-2, col[3]] <- anova(fit)[2,3]
  imp_results[i-2, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = fy_rec_whz_dev), data=df_sing_imp, color = cols[6]) +
    scale_x_continuous(limits = c(30, 280))
  print(fig)
}
```

### Continuous age + Multivariable logistic regression

```{r}
ddist <- datadist(df_cont)
options(datadist='ddist')

ddist <- datadist(df_cont)
options(datadist='ddist')

for (i in 3:5) {
  fit <- lrm(fy_rec_whz_dev ~ rcs(rsv_pcr_age, i) + sex, data=df_sing_imp)
  imp_results[i+1, col[1]] <- anova(fit)[1,1]
  imp_results[i+1, col[2]] <- anova(fit)[1,3]
  imp_results[i+1, col[3]] <- anova(fit)[2,3]
  imp_results[i+1, col[4]] <- anova(fit)[3,1]
  imp_results[i+1, col[5]] <- anova(fit)[3,3]
  imp_results[i+1, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = fy_rec_whz_dev), data=df_sing_imp, color = cols[6]) +
    scale_x_continuous(limits = c(30, 250))
  print(fig)
}

```

### Differenct outcome imputed models results summary

```{r}
imp_results
```

## Different imputation algorithm  

### algorithm  
### Step 1

1.  Pick up the children who were born between **2012/4/1** and **2013/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **also** missing, randomly drew a date between 2012/11/1 and 2013/4/1\
3.  Then calculate the age at RSV PCR positive

### Step 2

1.  Pick up the children who were born between **2013/4/1** and **2014/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **also** missing, randomly drew a date between 2013/11/1 and 2014/3/1\
3.  Then calculate the age at RSV PCR positive

### Step 3

1.  Pick up the children who were born between **2012/4/1** and **2013/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **not** missing, randomly drew a date between 2012/11/1 and **RSV serology sampling date**\
3.  Then calculate the age at RSV PCR positive

### Step 4

1.  Pick up the children who were born between **2013/4/1** and **2014/4/1**\
2.  If RSV PCR sampling date was missing and RSV serology sampling date was **not** missing, randomly drew a date between 2013/11/1 and **RSV serology sampling date**\
3.  Then calculate the age at RSV PCR positive

```{r include=FALSE}
set.seed(1234)

## step 1

for (row in 1:(nrow(df_sing_imp2 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))) {
  df_sing_imp2$rsv_pcr_age[row] = if_else(is.na(df_sing_imp2$rsv_pcr_age[row]) & !is.na(df_sing_imp2$lmday1[row]),  trunc(time_length(interval(df_sing_imp2$INFANTDOB[row], sample(seq(max(df_sing_imp2$INFANTDOB[row], as.Date("2012/11/1")), min(df_sing_imp2$lmday1[row], as.Date("2013/3/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp2$rsv_pcr_age[row])
}

## step 2

for (row in (nrow(df_sing_imp2 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp2 %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp2 %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp2$rsv_pcr_age[row] = if_else(is.na(df_sing_imp2$rsv_pcr_age[row]) & !is.na(df_sing_imp2$lmday1[row]),  trunc(time_length(interval(df_sing_imp2$INFANTDOB[row], sample(seq(max(df_sing_imp2$INFANTDOB[row], as.Date("2013/11/1")), min(df_sing_imp2$lmday1[row], as.Date("2014/3/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp2$rsv_pcr_age[row])
}

## step 3

for (row in 1:(nrow(df_sing_imp2 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))){
  df_sing_imp2$rsv_pcr_age[row] = if_else(is.na(df_sing_imp2$rsv_pcr_age[row]) & is.na(df_sing_imp2$lmday1[row]),  trunc(time_length(interval(df_sing_imp2$INFANTDOB[row], sample(seq(max(df_sing_imp2$INFANTDOB[row], as.Date("2012/11/1")), as.Date("2013/3/1"), by = "day"), 1)), "day")), df_sing_imp2$rsv_pcr_age[row])
}

## step 4  

for (row in (nrow(df_sing_imp2 %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp2 %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp2 %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp2$rsv_pcr_age[row] = if_else(is.na(df_sing_imp2$rsv_pcr_age[row]) & is.na(df_sing_imp2$lmday1[row]),  trunc(time_length(interval(df_sing_imp2$INFANTDOB[row], sample(seq(max(df_sing_imp2$INFANTDOB[row], as.Date("2013/11/1")), as.Date("2014/3/1"), by = "day"), 1)), "day")), df_sing_imp2$rsv_pcr_age[row])
}
```

### Validation

This figure illustrates the difference between real age at first RSV infection among the children who had positive PCR results and the imputed value. We aimed not to perfectly impute the age, but moderately estimate the age with some uncertainty. Our single imputation was not perfect, but good.

```{r}
## created a dataset for this validation  
df_sing_imp2_val <- df %>% 
  mutate(enroll_age = trunc(time_length(interval(INFANTDOB, STUDYENROLLDATE), "month")),
         MAT_EDUC_cat = case_when(MAT_EDUCYEARS < 9 ~ 0,
                                  9 <= MAT_EDUCYEARS & MAT_EDUCYEARS <= 12 ~ 1,
                                  12 < MAT_EDUCYEARS ~ 2),
         other_sib_cat = case_when(OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 0 ~ 0,
                                   OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL == 1 ~ 1,
                                   1 < OTHERLIVSIBS_BIO + OTHERLIVSIBS_HAL ~ 2),
         rsv_pcr_age = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_pcr_age_ori = trunc(time_length(interval(INFANTDOB, rftodaydate), "day")),
         rsv_sero_age = trunc(time_length(interval(INFANTDOB, lmday1), "day"))) %>% 
  filter(oy_rsv_infected_dev == 1) %>% 
  dplyr::select(cfsubjid, fycurrentasthma_dev, vycurrentasthma_dev, rsv_pcr_age, rsv_pcr_age_ori, sex, INFANTDOB, lmday1, oy_rec_whz_dev, ty_rec_whz_dev, ry_rec_whz_dev, vycurrentasthma_dev, vy_rec_whz_dev, xy_rec_whz_dev, oy_rsv_infected_dev) %>% 
  arrange(INFANTDOB) %>% 
  filter(!is.na(rsv_pcr_age)) %>% 
  mutate(val = NA_real_)

## perform the same imputation algorithm 
## caveat: we have to delete "if_else(is.na(df_sing_imp2$rsv_pcr_age[row]...".
set.seed(1234)

### step 1

for (row in 1:(nrow(df_sing_imp2_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))) {
  df_sing_imp2_val$rsv_pcr_age_val[row] = if_else(!is.na(df_sing_imp2_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp2_val$INFANTDOB[row], sample(seq(max(df_sing_imp2_val$INFANTDOB[row], as.Date("2012/11/1")), min(df_sing_imp2_val$lmday1[row], as.Date("2013/3/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp2_val$rsv_pcr_age_val[row])
}

### step 2

for (row in (nrow(df_sing_imp2_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp2_val %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp2_val %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp2_val$rsv_pcr_age_val[row] = if_else(!is.na(df_sing_imp2_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp2_val$INFANTDOB[row], sample(seq(max(df_sing_imp2_val$INFANTDOB[row], as.Date("2013/11/1")), min(df_sing_imp2_val$lmday1[row], as.Date("2014/3/1"), na.rm = TRUE), by = "day"), 1)), "day")), df_sing_imp2_val$rsv_pcr_age_val[row])
}

### step 3

for (row in 1:(nrow(df_sing_imp2_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))))){
  df_sing_imp2_val$rsv_pcr_age_val[row] = if_else(is.na(df_sing_imp2_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp2_val$INFANTDOB[row], sample(seq(max(df_sing_imp2_val$INFANTDOB[row], as.Date("2012/11/1")), as.Date("2013/3/1"), by = "day"), 1)), "day")), df_sing_imp2_val$rsv_pcr_age_val[row])
}

### step 4  

for (row in (nrow(df_sing_imp2_val %>% filter(as.Date("2012/4/1") <= INFANTDOB & INFANTDOB < as.Date("2013/4/1")))+1):(nrow(df_sing_imp2_val %>% filter(as.Date("2012/4/1")+1 <= INFANTDOB & INFANTDOB < as.Date("2013/4/1"))) + nrow(df_sing_imp2_val %>% filter(as.Date("2013/4/1") <= INFANTDOB & INFANTDOB < as.Date("2014/4/1"))))){
  df_sing_imp2_val$rsv_pcr_age_val[row] = if_else(is.na(df_sing_imp2_val$lmday1[row]),  trunc(time_length(interval(df_sing_imp2_val$INFANTDOB[row], sample(seq(max(df_sing_imp2_val$INFANTDOB[row], as.Date("2013/11/1")), as.Date("2014/3/1"), by = "day"), 1)), "day")), df_sing_imp2_val$rsv_pcr_age_val[row])
}

## compare the real value and imputed value among children who had a positive PCR result

graph <- ggplot(df_sing_imp2_val, aes(x = rsv_pcr_age_val, y = rsv_pcr_age_ori)) +
  geom_point() +
  labs(x = 'Imputed age', y = 'Original value') +
  xlim(0, 300) + 
  ylim(0, 300) + 
  geom_abline(intercept = 0, slope = 1, color = cols[6]) +
  theme_bw()
graph
```

### Jitter plot

This jitter plot illustrates the relationship between age at the first RSV infection and the **presence** of 5-year current asthma among the children who had PCR positive. The red dots indicate the children who developed asthma at age 5 years old. The red dots indicate the children who did not develop asthma at age 5 years.

```{r eval=FALSE, include=FALSE}
df_sing_imp2 <- df_sing_imp2 %>% 
  mutate(imp_tag = if_else(is.na(rsv_pcr_age_ori), 1, 0),
         color_tag = case_when(vycurrentasthma_dev == 0 & imp_tag == 0 ~ 0,
                               vycurrentasthma_dev == 0 & imp_tag == 1 ~ 1,
                               vycurrentasthma_dev == 1 & imp_tag == 0 ~ 2,
                               vycurrentasthma_dev == 1 & imp_tag == 1 ~ 3,))

cols <- brewer.pal(6, "Paired")
graph2 <- ggplot(df_sing_imp2, aes(x = rsv_pcr_age, y = jitter(vycurrentasthma_dev), color = as.factor(color_tag))) +
  geom_point() +
  scale_color_manual(values=cols[c(1,2,5,6)],
                     name = "Legend",
                     breaks = c("0", "1", "2", "3"),
                     labels = c("Only PCR +", "Imputed", "Only PCR +", "Imputed")) +
  labs(x = 'Age at first RSV PCR positive (days)', y = '5-year current asthma') +
  theme_classic() + 
  theme(axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_blank(),
        text = element_text(family = 'Helvetica'),
        axis.ticks.y = element_blank()) 
graph2
```

### Line plot

```{r}
df_sing_imp2_vis <- df_sing_imp2 %>% 
  drop_na(rsv_pcr_age, vycurrentasthma_dev)

df_summary2 <- df_sing_imp2_vis %>% 
  mutate(pcr_age_cat = cut(rsv_pcr_age, breaks = seq(0, 360, by = 10))) %>% 
  group_by(pcr_age_cat) %>%
  summarise(n = n(),
            noutcome = sum(vycurrentasthma_dev), na.rm = TRUE) %>%
  mutate(pcr_age_cat = seq(0, 300, by = 10),
         pcr_age_cat = factor(pcr_age_cat,
                              labels = c("0-10","10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100", "100-110", "110-120", "120-130", "130-140", "140-150", "150-160", "160-170", "170-180", "180-190", "190-200", "200-210", "210-220", "220-230", "230-240", "240-250", "250-260", "260-270", "270-280", "280-290", "290-300", "300-310")),
         names = as.character(pcr_age_cat),
         prob = noutcome/n)
df_summary2

graph2 <- ggplot() +
  geom_line(data = df_summary2, aes(x = pcr_age_cat, y = prob, color = "red", group = 1)) +
  geom_point(data = df_summary2, aes(x = pcr_age_cat, y = prob, color = "red")) +
  geom_line(data = df_summary, aes(x = pcr_age_cat, y = prob, color = "blue", group = 1)) +
  geom_point(data = df_summary, aes(x = pcr_age_cat, y = prob, color = "blue")) + 
  scale_color_manual(values=cols[c(2,6)],
                     name = "Legend",
                     breaks = c("blue", "red"),
                     labels = c("Only PCR +", "Imputed data")) +
  labs(x = 'Age at first RSV PCR positive (days)', y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 6),
    text = element_text(family = 'Helvetica'),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position="none"
  ) 
  
graph2
```

This figure illustrates the relationship between age at the first RSV infection and the **probability** of 5-year current asthma among the children who had PCR positive. The age at the first RSV infection was divided up into 10 day fragment to reflect the granularity of age effect. The blue line indicates the children who had positive RSC PCR while the red line indicates the imputed date set. Of course, the red line is less jagged than the blue line.

### Single imputed model

### Continuous age + Univariable logistic regression

```{r}
ddist <- datadist(df_sing_imp2)
options(datadist='ddist')

Knots <- c("3 knots", "4 knots", "5 knots")
Model <- c("Univariable", "Multivariable")
imp_results <- expand.grid(Knots = Knots, Model = Model)
col <- c("Coefficient of age", "p-value of age", "Non-linear effect", "Coefficient of sex", "p-value of sex", "AIC")
imp_results[, col] <- NA

plsmo(df_sing_imp2$rsv_pcr_age,
      df_sing_imp2$vycurrentasthma_dev,
      method = "lowess",
      xlab = "Age at first RSV PCR positive (days)",
      ylab = "Probability of 5-year current asthma")
title("Non-parametric smooth regression")

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i), data=df_sing_imp2)
  imp_results[i-2, col[1]] <- anova(fit)[1,1]
  imp_results[i-2, col[2]] <- anova(fit)[1,3]
  imp_results[i-2, col[3]] <- anova(fit)[2,3]
  imp_results[i-2, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 10),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp2, color = cols[6]) +
    scale_x_continuous(limits = c(30, 280))
  print(fig)
}
```

### Imputed models

### Continuous age + Multivariable logistic regression

```{r}
ddist <- datadist(df_sing_imp2)
options(datadist='ddist')

for (i in 3:5) {
  fit <- lrm(vycurrentasthma_dev ~ rcs(rsv_pcr_age, i) + sex, data=df_sing_imp2)
  imp_results[i+1, col[1]] <- anova(fit)[1,1]
  imp_results[i+1, col[2]] <- anova(fit)[1,3]
  imp_results[i+1, col[3]] <- anova(fit)[2,3]
  imp_results[i+1, col[4]] <- anova(fit)[3,1]
  imp_results[i+1, col[5]] <- anova(fit)[3,3]
  imp_results[i+1, col[6]] <- round(fit$stats['Model L.R.'] - 2*fit$stats['d.f.'], 2)

  fig <- ggplot(Predict(fit, fun=plogis, "rsv_pcr_age"), ylab="Probability of 5-year current asthma") +
  labs(x = 'Age at first RSV PCR positive (days)',
       y = 'Probability of 5-year current asthma',
       title = paste("Imputed model (RCS with ", i, " knots)")) +
  theme_classic() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 8),
    text = element_text(family = 'Helvetica'),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  ) +
    geom_rug(aes(x = rsv_pcr_age, y = vycurrentasthma_dev), data=df_sing_imp2, color = cols[6]) +
    scale_x_continuous(limits = c(30, 250))
  print(fig)
}

```

### Differnet algorithm Imputed models results summary

```{r}
imp_results
```
# Multiple imputation  

```{r eval=FALSE, include=FALSE}
df_sing_imp_multi_imp <- df_sing_imp %>% 
  dplyr::select(-cfsubjid, -rsv_pcr_age_ori, -INFANTDOB, -lmday1, -oy_rsv_infected_dev, -imp_tag, -color_tag) %>% 
  mutate(fycurrentasthma_dev=as.logical(fycurrentasthma_dev),
         vycurrentasthma_dev=as.logical(vycurrentasthma_dev),
         sex=as.logical(sex),
         oy_rec_whz_dev=as.logical(oy_rec_whz_dev),
         ty_rec_whz_dev=as.logical(ty_rec_whz_dev),
         ry_rec_whz_dev=as.logical(ry_rec_whz_dev),
         fy_rec_whz_dev=as.logical(fy_rec_whz_dev),
         vy_rec_whz_dev=as.logical(vy_rec_whz_dev),
         xy_rec_whz_dev=as.logical(xy_rec_whz_dev),
         DAYCARE_OY=as.logical(DAYCARE_OY),
         MATSMOKE_PREG=as.logical(MATSMOKE_PREG),
         MAT_ASTHMA_EVER=as.logical(MAT_ASTHMA_EVER),
         DELIVERYMODE=as.logical(DELIVERYMODE),
         OTHERLIVSIBS_BIO=factor(OTHERLIVSIBS_BIO)
         )

m <- 100
df_sing_imp_multi_imp100 <- mice(df_sing_imp_multi_imp,
                 m = m,
                 seed=1234,
                 maxit=50,
                 printFlag=FALSE)
plot(df_sing_imp_multi_imp100)
df_sing_imp_multi_imp100 %>% write_rds("df_sing_imp_multi_imp100.rds")

df_sing_imp_multi_imp100_stacked <- df_sing_imp_multi_imp100 %>% 
  complete(action="long")
```

## Categorized univariable logistic regression  

```{r eval=FALSE, include=FALSE}
res <- df_sing_imp_multi_imp100_stacked %>% 
  mutate(rsv_age_cat = case_when(rsv_pcr_age < 100 ~ 0,
                                 100 <= rsv_pcr_age & rsv_pcr_age < 200 ~ 1,
                                 200 < rsv_pcr_age ~ 2)) %>% 
  group_by(.imp) %>%
  nest() %>% 
  mutate(fit = map(data, ~glm(vycurrentasthma_dev ~ factor(rsv_age_cat), family = binomial, data = .)))

combined_results <- MIcombine(res$fit, call=NULL)
messy <- summary(combined_results)
exp(messy[, 1:4])
```

## Categorized univariable logistic regression  

```{r eval=FALSE, include=FALSE}
res <- df_sing_imp_multi_imp100_stacked %>% 
  mutate(rsv_age_cat = case_when(rsv_pcr_age < 100 ~ 0,
                                 100 <= rsv_pcr_age & rsv_pcr_age < 200 ~ 1,
                                 200 < rsv_pcr_age ~ 2)) %>% 
  group_by(.imp) %>%
  nest() %>% 
  mutate(fit = map(data, ~glm(vycurrentasthma_dev ~ factor(rsv_age_cat) + sex, family = binomial, data = .)))

combined_results <- MIcombine(res$fit, call=NULL)
messy <- summary(combined_results)
exp(messy[, 1:4])
```

## Line plot  
```{r eval=FALSE, include=FALSE}
df_summary_imp <- df_sing_imp_multi_imp100_stacked %>% 
  mutate(pcr_age_cat = cut(rsv_pcr_age, breaks = seq(0, 360, by = 10))) %>% 
  group_by(pcr_age_cat) %>%
  summarise(n = n(),
            noutcome = sum(vycurrentasthma_dev), na.rm = TRUE) %>%
  mutate(pcr_age_cat = seq(0, 290, by = 10),
         pcr_age_cat = factor(pcr_age_cat,
                              labels = c("0-10","10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90", "90-100", "100-110", "110-120", "120-130", "130-140", "140-150", "150-160", "160-170", "170-180", "180-190", "190-200", "200-210", "210-220", "220-230", "230-240", "240-250", "250-260", "260-270", "270-280", "280-290", "290-300")),
         names = as.character(pcr_age_cat),
         prob = noutcome/n)
df_summary_imp

graph2 <- ggplot() +
  geom_line(data = df_summary_imp, aes(x = pcr_age_cat, y = prob, color = "red", group = 1)) +
  geom_point(data = df_summary_imp, aes(x = pcr_age_cat, y = prob, color = "red")) +
  geom_line(data = df_summary, aes(x = pcr_age_cat, y = prob, color = "blue", group = 1)) +
  geom_point(data = df_summary, aes(x = pcr_age_cat, y = prob, color = "blue")) + 
  scale_color_manual(values=cols[c(2,6)],
                     name = "Legend",
                     breaks = c("blue", "red"),
                     labels = c("Only PCR +", "Imputed data")) +
  labs(x = 'Age at first RSV PCR positive (days)', y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 6),
    text = element_text(family = 'Helvetica'),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position="none"
  ) 
  
graph2
```

```{r eval=FALSE, include=FALSE}
df_sing_imp_vis <- df_sing_imp_multi_imp100_stacked %>% 
  drop_na(rsv_pcr_age, vycurrentasthma_dev) %>% 
  filter(EVERBREASTFED==0)

df_sing_imp_vis2 <- df_sing_imp_multi_imp100_stacked %>% 
  drop_na(rsv_pcr_age, vycurrentasthma_dev) %>% 
  filter(EVERBREASTFED==1)

df_summary1 <- df_sing_imp_vis %>% 
  mutate(pcr_age_cat = cut(rsv_pcr_age, breaks = seq(0, 240, by = 30))) %>% 
  group_by(pcr_age_cat) %>%
  summarise(n = n(),
            noutcome = sum(vycurrentasthma_dev), na.rm = TRUE) %>%
  mutate(pcr_age_cat = seq(0, 240, by = 30),
         pcr_age_cat = factor(pcr_age_cat,
                              labels = c("1 month","2 month", "3 months", "4 months", "5 months", "6 months", "7 months", "8 months", "9 months")),
         names = as.character(pcr_age_cat),
         prob = noutcome/n)

df_summary1 %>% write.csv("exp1.csv")

df_summary2 <- df_sing_imp_vis2 %>% 
  mutate(pcr_age_cat = cut(rsv_pcr_age, breaks = seq(0, 240, by = 30))) %>% 
  group_by(pcr_age_cat) %>%
  summarise(n = n(),
            noutcome = sum(vycurrentasthma_dev), na.rm = TRUE) %>%
  mutate(pcr_age_cat = seq(0, 240, by = 30),
         pcr_age_cat = factor(pcr_age_cat,
                              labels = c("1 month","2 month", "3 months", "4 months", "5 months", "6 months", "7 months", "8 months", "9 months")),
         names = as.character(pcr_age_cat),
         prob = noutcome/n)

df_summary2 %>% write.csv("exp2.csv")

graph2 <- ggplot() +
  geom_line(data = df_summary2, aes(x = pcr_age_cat, y = prob, color = "red", group = 1)) +
  geom_point(data = df_summary2, aes(x = pcr_age_cat, y = prob, color = "red")) +
  geom_line(data = df_summary1, aes(x = pcr_age_cat, y = prob, color = "blue", group = 1)) +
  geom_point(data = df_summary1, aes(x = pcr_age_cat, y = prob, color = "blue")) + 
  scale_color_manual(values=cols[c(2,6)],
                     name = "Legend",
                     breaks = c("blue", "red"),
                     labels = c("Only PCR +", "Imputed data")) +
  labs(x = 'Age at first RSV PCR positive (months)', y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 6),
    text = element_text(family = 'Helvetica'),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position="none"
  ) 

graph2

graph3 <- ggplot() +
  geom_line(data = df_summary2, aes(x = pcr_age_cat, y = n, color = "red", group = 1)) +
  geom_point(data = df_summary2, aes(x = pcr_age_cat, y = n, color = "red")) +
  geom_line(data = df_summary1, aes(x = pcr_age_cat, y = n, color = "blue", group = 1)) +
  geom_point(data = df_summary1, aes(x = pcr_age_cat, y = n, color = "blue")) + 
  scale_color_manual(values=cols[c(2,6)],
                     name = "Legend",
                     breaks = c("blue", "red"),
                     labels = c("Only PCR +", "Imputed data")) +
  labs(x = 'Age at first RSV PCR positive (months)', y = 'Probability of 5-year current asthma') +
  theme_classic() +
  theme(
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 6),
    text = element_text(family = 'Helvetica'),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position="none"
  ) 

graph3
```

